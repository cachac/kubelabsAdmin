
# 1. HPA
[Documentación Oficial](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/)

> [ScaleDown](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#configurable-scaling-behavior)

> [Custom Metrics](https://github.com/kubernetes-sigs/custom-metrics-apiserver)

## 1.1. Ejecutar el archvivo:
> [hpa-definition.yml](./assets/hpa-definition.yml)

```vim
kubectl apply -f assets/hpa-definition.yml
```

Escala de acuerdo a las siguientes métricas:
```yaml
minReplicas: 1
maxReplicas: 10
cpu: 30
memoria: 30
```
## 1.2. Validar:
```vim
kubectl get pods -l run=php-apache
```
```yaml
NAME                          READY   STATUS    RESTARTS   AGE
php-apache-6fff8db564-clkmx   1/1     Running   0          37m
```
> Hay una replica en ejecución.

```vim
kg hpa -w
```
> -w = watch
```vim
NAME         REFERENCE               TARGETS         MINPODS   MAXPODS   REPLICAS
php-apache   Deployment/php-apache   25%/30% 0%/30%  1         10        1
```

> TARGETS: MEM - CPU

> Toma algunos segundos para mostrar la información de consumo.

## 1.3. En otra terminal, generar tráfico al Pod configurado
```vim
kubectl run -it load-generator --rm --image=busybox --restart=Never -- /bin/sh -c "while sleep 0.01; do wget -q -O- http://php-apache; done"
```
En caso de error, ejecutarlo en dos partes:

```vim
kubectl run -it load-generator --rm --image=busybox --restart=Never
# dentro del contenedor ejecutar:
while sleep 0.01; do wget -q -O- http://php-apache; done
```

El Pod ***load-generator*** envía tráfico al Pod ***php-apache***, eso incrementa el uso de CPU


```yaml
NAME         REFERENCE               TARGETS          MINPODS   MAXPODS   REPLICAS
php-apache   Deployment/php-apache   27%/30%, 70%/30% 1         10        6
```
> Se visualiza el porcentaje del ***TARGET***

> Aumenta la cantidad de replicas.

## 1.4. Detener el pod de carga y limpiar

```vim
kubectl delete all --all
```

# 2. HPA Ingress
## 2.1. Crear pods
```vim
ka assets/05/podinfo.yml
```
> [podinfo](https://artifacthub.io/packages/helm/podinfo/podinfo)
https://computingforgeeks.com/setup-prometheus-and-grafana-on-kubernetes/                              Prometheus:

kubectl --namespace monitoring patch svc prometheus-k8s -p '{"spec": {"type": "NodePort"}}'
Alertmanager:

kubectl --namespace monitoring patch svc alertmanager-main -p '{"spec": {"type": "NodePort"}}'
Grafana:

kubectl --namespace monitoring patch svc grafana -p '{"spec": {"type": "NodePort"}}'
https://computingforgeeks.com/setup-prometheus-and-grafana-on-kubernetes/
#  3. Obtener la IP del pod nginx en el nodo donde corre podinfofsd
```vim
# ver el nodo de podinfo
kubectl get pods -o wide -n kube-system

# ver ip nginx del nodo
kubectl get pods -o wide -n kube-system
```
# Ejecutar pod de carga
```vim
kubectl run -ti --rm=true busybox --image=busybox

wget -qO- <IP_address>:9113/metrics
```
metrics
http://carlos63.kubelabs.tk:9100/metrics
# HELM repo
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

helm repo add stable https://charts.helm.sh/stable

helm install prometheus prometheus-community/prometheus --set server.storageClass=local-storage --set server.service.type=NodePort --set server.service.nodePort=30010

kubectl get pods

