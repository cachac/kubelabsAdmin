# 10. RBAC <!-- omit in TOC -->

< [info](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)

> Requerido el lab 09. KubeConfig
# 1. Modo de autorización del Cluster
```vim
kubectl describe pod kube-apiserver-cp01-USERLAB-kubelabs-tk -n kube-system | grep authorization
```

>  --authorization-mode=Node,RBAC

> RBAC está activo

# 2. Ver roles
```vim
k get roles --all-namespaces

kd roles rke2-ingress-nginx -n kube-system
```
> Resource Names = Recurso
>
> Verbs = acción


# 3. User Roles

## 3.1. Crear Role y asignarlo al usuario (Binding)
```yaml
ka assets/10/role.yml

# sustituir el nombre del usuario
ka assets/10/rolebinding.yml
```

# 4. Simular uso del rol
## 4.1. Listar pods en ns prod-apps
```vim
kubectl get pods --as <USER> -n prod-apps
```

## 4.2. Crear Pods
```vim
k run prod-pod --image nginx-alpine --as <USER> -n prod-apps
```
## 4.3. Eliminar
```vim
kubectl delete pod prod-pod --as <USER> -n prod-apps
```
> User "USER" cannot delete resource "pods" in API group "" in the namespace "prod-apps"


## 4.4. Cambiar role para eliminar Pods
En role.yml agregar:
> verbs: ["list", "create", "delete"]
```vim
ka assets/10/role.yml
```
## 4.5. Eliminar Pods
> pod "prod-pod" deleted

# 5. Extra: Crear certificados
> [crear cert openssl](https://www.cncf.io/blog/2020/07/31/kubernetes-rbac-101-authentication/)
## 5.1. Copiar CA y CA-Key del server
> /var/lib/rancher/rke2/server/tls

> server-ca.crt
>
> server-ca.key

## 5.2. Generar: user private key
```vim
export $USER=<USER>

openssl genrsa -out $USER.key 2048
```

## 5.3. Generar: user client Cert
```vim
openssl req -new -key $USER.key -out $USER.csr -subj "/CN=$USER/O=kubelabs"
```
## 5.4. Firmar
```vim
openssl x509 -req -in $USER.csr -CA server-ca.crt -CAkey server-ca.key -set_serial 101 -extensions client -days 365 -outform PEM -out $USER.crt
```

> Genera un nuevo certificado firmado con los certificados del servidor

## 5.5. Cambiar el .kube/config con los valores del certificado firmado:
```yaml
users:
- name: default
  user:
    client-certificate: <DIRECTORIO-USER-CRT>
		client-key: <DIRECTORIO-USER-KEY>
```

## 5.6. Opcional: Cambiar un base64 a cert
```python
openssl base64 -d -A -in cluster-base64-ca -out cluster-ca.crt
```

